
#### 达成目标  
1. 弄清Looper、Handler、Thread、MessageQueue的关系  
2. ThreadLocal有什么用？适用的场景  
3. 为什么不能在子线程创建Handler？  
4. 消息队列的工作原理  
5. Looper的工作原理  
6. Handler的工作原理  
7. 主线程的消息循环  

* 扩展: 自己设计一个消息循环处理框架  

#### 完成时间: 一周  


# Android 消息机制  

#### 什么是消息机制，Android的消息机制是什么？    
1. 消息机制主要由消息的存储单元、消息处理单元、消息本身 几大部分组成。  
   消息队列: （英语：Message queue）是一种进程间通信或同一进程的不同线程间的通信方式，软件的贮列用来处理一系列的输入，通常是来自用户。消息队列提供了异步的通信协议，每一个贮列中的纪录包含详细说明的数据，包含发生的时间，输入设备的种类，以及特定的输入参数，也就是说：消息的发送者和接收者不需要同时与消息队列互交。消息会保存在队列中，直到接收者取回它   

* Producer：消息生产者，负责产生和发送消息到 Broker；   
* Broker：消息处理中心。负责消息存储、确认、重试等，一般其中会包含多个 queue；   
* Consumer：消息消费者，负责从 Broker 中获取消息，并进行相应处理；     
  以上是通用的消息机制设计，一图以蔽之
  ![消息机制](https://github.com/jasonGeng88/blog/blob/master/201705/assets/mq_01.png)    

  Andrid的消息机制主要是指Handler的运行机制，Handler的运行机制需要底层的MessageQueue和Looper的支持。
  * MessageQueue(消息队列): 它本身并非队列而是在其内部采用的单链表的数据结构来存储消息列表，以队列的形式对外提供插入和删除的工作 。MessageQueue
    本身只负责存储消息，不处理消息
  * Looper: Looper会以无限循环的形式去查找是否有消息，如果有的话就去处理消息，否则就一直等待着。
  * Message: 消息体
  *  Handler：负责将消息中携带的任务切换到某个指定的线程中去执行。

#### Q：Handler的主要作用是将一个任务切换到某个指定的线程中去执行，那么Android为什么要提供这个功能呢？或者说Android为什么需要提供在某个具体
####  线程中执行任务的这种功能？
          A:  原因就是Android规定访问UI只能在主线程中进行，如果在子线程中访问UI，那么程序就会抛出异常。ViewRooImpl对UI操作做了验证。如下
```java
void checkThread(){
    if(mThread != Thread.currentThread()){
        throw new CalledFromWrongThreadException(
            "Only the original thread that created a view hierarchy can touch its views."
        )
    }
}
```
针对checkThread中抛出的异常，① 由于这一点的限制 导致必须在主线程中访问UI，②但是Android又不建议在主线程执行耗时逻辑。比如从网络拉取图片显示，时间过长肯定会ANR。所以系统之所以提供Handler 主要是为了解决在子线程中无法访问UI的矛盾。    

####   Q:  系统为什么不允许在子线程访问UI呢?   
A： 主要还是因为Android的UI控件不是线程安全的，如果多线程操作会导致UI控件处于不可预期的状态。可以通过加锁的方式解决。但是加锁虽然能解决并发访问的问题但是会带来一下两个负面影响  
1. 首先加锁会让UI访问的逻辑变得复杂  
2. 加锁会降低UI的访问效率，因为锁机制会阻塞某些线程的执行。  
所以鉴于以上的两个缺点，最简单高效的办法就是 采用单线程模型更新UI，对于开发者来说也就是切换下线程的即可。  
![H](https://note.youdao.com/yws/public/resource/786ccedb17aff50ea17ca95a4c9fb963/xmlnote/C999DC6DFF1448FEB59A8CEDB8116768/33338)


 
#  ThreadLoacl的工作原理   

#  Looper的工作原理   

#  MessageQueue的工作原理   

#  Handler的工作原理  



















